<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The zcashd Book</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">zcashd</a></li><li class="chapter-item expanded "><a href="user.html"><strong aria-hidden="true">1.</strong> User Documentation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="user/metrics.html"><strong aria-hidden="true">1.1.</strong> Metrics</a></li></ol></li><li class="chapter-item expanded "><a href="dev.html"><strong aria-hidden="true">2.</strong> Developer Documentation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="dev/rust.html"><strong aria-hidden="true">2.1.</strong> Rust in zcashd</a></li></ol></li><li class="chapter-item expanded "><a href="design.html"><strong aria-hidden="true">3.</strong> Design</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="design/chain-state.html"><strong aria-hidden="true">3.1.</strong> Chain state</a></li><li class="chapter-item expanded "><a href="design/coins-view.html"><strong aria-hidden="true">3.2.</strong> &quot;Coins&quot; view</a></li><li class="chapter-item expanded "><a href="design/p2p-data-propagation.html"><strong aria-hidden="true">3.3.</strong> P2P data propagation</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The zcashd Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1>Zcash 4.5.1-1
<img align="right" width="120" height="80" src="doc/imgs/logo.png"></h1>
<h2 id="what-is-zcash"><a class="header" href="#what-is-zcash">What is Zcash?</a></h2>
<p><a href="https://z.cash/">Zcash</a> is an implementation of the &quot;Zerocash&quot; protocol.
Based on Bitcoin's code, Zcash intends to offer a far higher standard of privacy
through a sophisticated zero-knowledge proving scheme that preserves
confidentiality of transaction metadata. More technical details are available
in our <a href="https://zips.z.cash/protocol/protocol.pdf">Protocol Specification</a>.</p>
<p>This software is the Zcash client. It downloads and stores the entire history
of Zcash transactions; depending on the speed of your computer and network
connection, the synchronization process could take a day or more once the
blockchain has reached a significant size.</p>
<p align="center">
  <img src="doc/imgs/zcashd_screen.gif" height="500">
</p>
<h4 id="lock-security-warnings"><a class="header" href="#lock-security-warnings">:lock: Security Warnings</a></h4>
<p>See important security warnings on the
<a href="https://z.cash/support/security/">Security Information page</a>.</p>
<p><strong>Zcash is experimental and a work in progress.</strong> Use it at your own risk.</p>
<h4 id="ledger-deprecation-policy"><a class="header" href="#ledger-deprecation-policy">:ledger: Deprecation Policy</a></h4>
<p>This release is considered deprecated 16 weeks after the release day. There
is an automatic deprecation shutdown feature which will halt the node some
time after this 16-week period. The automatic feature is based on block
height.</p>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h2>
<p>Please see our <a href="https://zcash.readthedocs.io/en/latest/rtd_pages/rtd_docs/user_guide.html">user guide</a> for joining the main Zcash network.</p>
<h3 id="need-help"><a class="header" href="#need-help">Need Help?</a></h3>
<ul>
<li>:blue_book: See the documentation at the <a href="https://zcash.readthedocs.io">ReadTheDocs</a>
for help and more information.</li>
<li>:incoming_envelope: Ask for help on the <a href="https://forum.z.cash/">Zcash</a> forum.</li>
<li>:speech_balloon: Join our community on <a href="https://discordapp.com/invite/PhJY6Pm">Discord</a></li>
</ul>
<p>Participation in the Zcash project is subject to a
<a href="code_of_conduct.html">Code of Conduct</a>.</p>
<h3 id="building"><a class="header" href="#building">Building</a></h3>
<p>Build Zcash along with most dependencies from source by running the following command:</p>
<pre><code>./zcutil/build.sh -j$(nproc)
</code></pre>
<p>Currently, Zcash is only officially supported on Debian and Ubuntu. See the
<a href="https://zcash.readthedocs.io/en/latest/rtd_pages/Debian-Ubuntu-build.html">Debian / Ubuntu build</a>
for detailed instructions.</p>
<h2 id="license"><a class="header" href="#license">License</a></h2>
<p>For license information see the file <a href="COPYING">COPYING</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="user-documentation"><a class="header" href="#user-documentation">User Documentation</a></h1>
<p>This section contains user documentation specific to <code>zcashd</code>.</p>
<p>See <a href="https://zcash.readthedocs.io/">here</a> for more general Zcash documentation, as well as
installation instructions for <code>zcashd</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="zcashd-metrics"><a class="header" href="#zcashd-metrics">zcashd metrics</a></h1>
<h2 id="metrics-ui"><a class="header" href="#metrics-ui">Metrics UI</a></h2>
<p>This is the user interface that <code>zcashd</code> displays by default when run. It
displays a small selection of interesting metrics, but is not intended for
programmatic consumption.</p>
<h2 id="rpc-methods"><a class="header" href="#rpc-methods">RPC methods</a></h2>
<p><code>zcashd</code> provides the following JSON-RPC methods that expose node metrics:</p>
<ul>
<li>Chain:
<ul>
<li><code>getblockchaininfo</code>: Various state info regarding block chain processing.</li>
<li><code>gettxoutsetinfo</code>: Statistics about the unspent transparent transaction output set.</li>
<li><code>getmempoolinfo</code>: Details on the active state of the TX memory pool.</li>
</ul>
</li>
<li>P2P network:
<ul>
<li><code>getnetworkinfo</code>: Various state info regarding P2P networking.</li>
<li><code>getpeerinfo</code>: Data about each connected network node.</li>
<li><code>getdeprecationinfo</code>: The current node version and deprecation block height.</li>
</ul>
</li>
<li>Miscellaneous
<ul>
<li><code>getmemoryinfo</code>: Information about memory usage.</li>
<li><code>getmininginfo</code>: Mining-related information.</li>
<li><code>getinfo</code> (deprecated): A small subset of the above metrics.</li>
</ul>
</li>
</ul>
<p>You can see what each method provides with <code>zcash-cli help METHOD_NAME</code>.</p>
<h2 id="prometheus-support"><a class="header" href="#prometheus-support">Prometheus support</a></h2>
<p><code>zcashd</code> can optionally expose an HTTP server that acts as a Prometheus scrape
endpoint. The server will respond to <code>GET</code> requests on any request path.</p>
<p>To enable the endpoint, add <code>-prometheusport=&lt;port&gt;</code> to your <code>zcashd</code>
configuration (either in <code>zcash.conf</code> or on the command line). After
restarting <code>zcashd</code> you can then test the endpoint by querying it:</p>
<pre><code>$ curl http://127.0.0.1:&lt;port&gt;
# TYPE zcash_net_out_messages counter
zcash_net_out_messages 181

# TYPE zcash_net_in_bytes_total counter
zcash_net_in_bytes_total 3701998

# TYPE zcash_net_in_messages counter
zcash_net_in_messages 184

# TYPE zcashd_build_info counter
zcashd_build_info{version=&quot;v4.2.0&quot;} 1

# TYPE zcash_chain_verified_block_total counter
zcash_chain_verified_block_total 162
...
</code></pre>
<p>By default, access is restricted to localhost. This can be expanded with
<code>-metricsallowip=&lt;ip&gt;</code>, which can specify IPs or subnets. Note that HTTPS is not
supported, and therefore connections to the endpoint are not encrypted or
authenticated. Access to the endpoint should be assumed to compromise the
privacy of node operations, by the provided metrics and/or by timing side
channels. Non-localhost access is <strong>strongly discouraged</strong> if the node has a
wallet holding live funds.</p>
<h3 id="example-metrics-collection-with-docker"><a class="header" href="#example-metrics-collection-with-docker">Example metrics collection with Docker</a></h3>
<p>The example instructions below were tested on Windows 10 using Docker Desktop
with the WSL 2 backend, connected to a <code>zcashd</code> running inside WSL2 (but not
inside Docker):</p>
<pre><code># Create a storage volume for Grafana (once)
docker volume create grafana-storage

# Create a storage volume for Prometheus (once)
docker volume create prometheus-storage

# Run Prometheus
# You will need to modify ~/contrib/metrics/prometheus.yaml to match the
# port configured with -prometheusport and -metricsbind / -metricsallowip
# (and possibly also for your Docker network setup).
docker run --detach -p 9090:9090 --volume prometheus-storage:/prometheus --volume ~/contrib/metrics/prometheus.yaml:/etc/prometheus/prometheus.yml  prom/prometheus

# Run Grafana
docker run --detach -p 3030:3030 --env GF_SERVER_HTTP_PORT=3030 --volume grafana-storage:/var/lib/grafana grafana/grafana
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="developer-documentation"><a class="header" href="#developer-documentation">Developer Documentation</a></h1>
<p>This section contains documentation aimed at contributors to the <code>zcashd</code> codebase.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rust-in-zcashd"><a class="header" href="#rust-in-zcashd">Rust in <code>zcashd</code></a></h1>
<p><code>zcashd</code> is primarily a C++ codebase, but most new code is being written in Rust
where possible.</p>
<h2 id="adding-new-dependencies-in-online-rust-mode"><a class="header" href="#adding-new-dependencies-in-online-rust-mode">Adding new dependencies in online-Rust mode</a></h2>
<p>The <code>zcashd</code> build system pins all dependencies, and in order to facilitate
deterministic builds, <code>cargo</code> is configured to run in offline mode with vendored
crates. This means that if, for example, you add the <code>foobar</code> crate to
<code>Cargo.toml</code>, you will likely see an error similar to this:</p>
<pre><code>$ cargo check
error: no matching package named `foobar` found
location searched: registry `https://github.com/rust-lang/crates.io-index`
required by package `librustzcash v0.2.0 (/path/to/zcash)`
</code></pre>
<p>Instead, you first need to build <code>zcashd</code> in online-Rust mode:</p>
<pre><code>CONFIGURE_FLAGS=--enable-online-rust ./zcutil/build.sh
</code></pre>
<p>After doing so, you can add a new dependency as follows:</p>
<ol>
<li>Add the new dependency to <code>Cargo.toml</code>.</li>
<li>Run <code>cargo check</code> to update the <code>Cargo.lock</code> file.</li>
<li>Commit <code>Cargo.toml</code> and <code>Cargo.lock</code>.</li>
</ol>
<h2 id="using-a-local-rust-dependency"><a class="header" href="#using-a-local-rust-dependency">Using a local Rust dependency</a></h2>
<p>During development, you can use a locally checked out version of a dependency
by applying a <a href="https://doc.rust-lang.org/cargo/reference/overriding-dependencies.html#the-patch-section"><code>cargo</code> patch</a>.</p>
<p>For example, to use a local version of the <code>orchard</code> crate that includes a new
API, add the following patch to <code>Cargo.toml</code>:</p>
<pre><code>[dependencies]
# This dependency is listed with a version, meaning it comes from crates.io; the
# patch goes into a [patch.crates-io] section.
orchard = &quot;0.0&quot;
...

[patch.crates-io]
# Comment out any existing patch, if present.
# orchard = { git = &quot;https://github.com/zcash/orchard.git&quot;, rev = &quot;...&quot; }

# Add this patch (both relative and absolute paths work):
orchard = { path = &quot;../relative/path/to/orchard&quot; }
</code></pre>
<p>Usually you can apply a patch to use a locally checked out dependency without
needing to build <code>zcashd</code> in online-Rust mode. However, if your local changes
include a new dependency, you will need to ensure you are in online-Rust mode.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="design"><a class="header" href="#design">Design</a></h1>
<p>Zcash was originally a fork of Bitcoin 0.11.2, and as such the <code>zcashd</code> node architecture
is very similar to <code>bitcoind</code>. There are however several differences, most notably the
addition of shielded pools to the consensus logic and full node state.</p>
<p>In this section of the book, we describe the overall architecture that we inherit from
<code>bitcoind</code>, the changes we have made to the inherited components, and the new components
we have introduced.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chain-state"><a class="header" href="#chain-state">Chain state</a></h1>
<p>TBD</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="coins-view"><a class="header" href="#coins-view">&quot;Coins&quot; view</a></h1>
<p>TBD</p>
<h2 id="notes"><a class="header" href="#notes">Notes</a></h2>
<ul>
<li>This is the main context in which <code>CTxOut::IsNull()</code> is used. The other is a
single spot in the mempool code. Once we've backported the
<a href="https://github.com/bitcoin/bitcoin/pull/10195">per-txout CoinsDB</a> we can
hopefully eliminate this method.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="p2p-data-propagation"><a class="header" href="#p2p-data-propagation">P2P data propagation</a></h1>
<p>This page contains notes about how block and transaction data is tracked and propagated by
<code>zcashd</code>. Most of this behaviour is inherited from Bitcoin Core, but some differences have
developed.</p>
<p>Some of this content is duplicated from in-code comments, but assembling this summary in
one place is generally useful for understanding the overall dynamic :)</p>
<h2 id="recentrejects"><a class="header" href="#recentrejects"><code>recentRejects</code></a></h2>
<p>When a transaction is rejected by <code>AcceptToMemoryPool</code>, the transaction is added to the
<code>recentRejects</code> Bloom filter, so that we don't process it again. The Bloom filter resets
whenever the chain tip changes, as previously invalid transactions might become valid.</p>
<p>To prevent DoS attacks against wallets submitting transactions, <code>recentRejects</code> needs to
store a commitment to the entire transaction. This ensures that if a transaction is
malleated by a network peer to invalidate its authorizing data, the node will ignore
future advertisements of that specific transaction, but still request alternative versions
of the same txid (which might have valid authorizing data).</p>
<ul>
<li>For pre-v5 transactions, the txid commits to the entire transaction, and the wtxid is
the txid with a globally-fixed (all-ones) suffix.</li>
<li>For v5+ transactions, the wtxid commits to the entire transaction.</li>
</ul>
<h2 id="maporphantransactions"><a class="header" href="#maporphantransactions"><code>mapOrphanTransactions</code></a></h2>
<p>Upstream uses this map to store transactions that are rejected by <code>AcceptToMemoryPool</code>
because the node doesn't have their transparent inputs. <code>zcashd</code> inherits this behaviour
but limits it to purely-transparent transactions (that is, if a transaction contains any
shielded components, the node rejects it as invalid and adds it to <code>recentRejects</code>).</p>
<p><code>mapOrphanTransactions</code> indexes transactions by txid. This means that if an orphan
transaction is received (spending transparent UTXOs the node does not know about), and it
also happens to be invalid for other reasons (subsequent <code>AcceptToMemoryPool</code> rules that
haven't yet been checked), then the node will not request any v5+ transactions with the
same txid but different authorizing data. This does not create a DoS problem for wallets,
because an adversary that manipulated an orphan transaction to be invalid under the above
constraints would also need to prevent the orphan's parent from entering the mempool, and
eventually a parent is reached that is not an orphan. Once the orphan's direct parent is
accepted, the orphan is re-evaluated, and if it had been manipulated to be invalid, its
wtxid is added to <code>recentRejects</code> while its txid is removed from <code>mapOrphanTransactions</code>,
enabling the wallet to rebroadcast the unmodified transaction.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
